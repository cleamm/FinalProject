{% extends 'base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <style>
        /* 기본 스타일 정의 */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: #fff;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 반전 모드 스타일 */
        .dark-mode {
            background-color: #fff;
            color: #000;
        }

        /* 메인 컨테이너 스타일 */
        .container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            width: 90%;
            max-width: 1200px;
            margin: 50px auto;
        }

        /* 섹션 그룹 스타일 */
        .info-group,
        .settings-group {
            width: 48%;
        }

        /* 섹션 스타일 */
        .section {
            padding: 20px;
            margin-bottom: 20px;
            background: #333;
            color: #fff;
            border-radius: 15px; /* 부드러운 테두리 */
            border: 1px solid #444; /* 테두리 설정 */
            background-clip: padding-box; /* 테두리 스타일 유지 */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(255, 255, 255, 0.1); /* 외부 그림자 및 내부 반사 */
            transition: background 0.3s, color 0.3s, box-shadow 0.3s;
        }

        /* 반전 모드 섹션 스타일 */
        .dark-mode .section {
            background: #f4f4f4;
            color: #000;
            border: 1px solid #ccc; /* 경계선 색상 조정 */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1), inset 0 0 10px rgba(0, 0, 0, 0.05); /* 그림자 조정 */
        }

        /* 섹션 제목 스타일 */
        .section h2 {
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
        }

        /* 입력, 버튼, 텍스트 영역 스타일 */
        .section input[type="password"],
        .section select,
        .section button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #555;
            border-radius: 5px;
            background: #444;
            color: #fff;
            transition: background 0.3s, border-color 0.3s, color 0.3s;
            box-sizing: border-box;
        }

        /* 반전 모드 입력, 텍스트 영역 스타일 */
        .dark-mode .section input[type="password"],
        .dark-mode .section select {
            background: #fff;
            color: #000;
            border: 1px solid #ccc;
        }

        /* 일반 버튼 스타일 */
        .section button {
            background: linear-gradient(45deg, #eda333, #ffdd55);
            color: #fff;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
            border: none;
            font-size: 1em;
            padding: 12px;
            border-radius: 8px; /* 더 부드러운 버튼 모서리 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 일반 버튼 호버 스타일 */
        .section button:hover {
            background: linear-gradient(45deg, #e88b00, #ffcc00); /* 호버 시 색상 조정 */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px); /* 호버 시 살짝 위로 올라가는 효과 */
        }

        /* 회원 탈퇴 버튼 스타일 */
        .delete-button {
            background: linear-gradient(45deg, #ff4c4c, #ff6666) !important;
        }

        /* 회원 탈퇴 버튼 호버 스타일 */
        .delete-button:hover {
            background: linear-gradient(45deg, #e60000, #ff4c4c) !important;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 1s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 수평 섹션 스타일 */
        .horizontal-sections {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        /* 수평 섹션 내부 섹션 스타일 */
        .horizontal-sections .section {
            flex: 1;
            margin-bottom: 0;
        }

        .chat-extraction {
            margin-top: 30px;
        }

        .home-button {
            margin-top: 30px;
        }

        /* 회원 탈퇴 섹션 상단 여백 추가 */
        .member-delete {
            margin-top: 20px;
        }

        /* 장르 목록 스타일 */
        .genre-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .genre-item {
            flex: 0 1 calc(33.33% - 10px);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .genre-item label {
            flex: 1;
            text-align: left;
            color: #fff;
        }

        /* 반전 모드에서의 장르 목록 스타일 */
        .dark-mode .genre-item label {
            color: #000;
        }
    </style>
    <script>
        // 페이지 로드 시 설정된 반전 모드 상태를 적용
        document.addEventListener('DOMContentLoaded', () => {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }

            // 음성 버튼 상태에 따라 버튼 텍스트 변경
            updateSpeechButtonText();
        });

        // 반전 모드를 토글하는 함수
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
        }

        // 음성 인식 버튼 토글 함수
        function toggleSpeechButton() {
            // 현재 숨김 상태를 로컬 스토리지에서 가져옴
            const isHidden = localStorage.getItem('speechButtonHidden') === 'true';
            // 새 숨김 상태를 로컬 스토리지에 저장
            localStorage.setItem('speechButtonHidden', !isHidden);

            // 메인 페이지로 음성 버튼 숨기기/보이기 이벤트 전송
            if (window.opener) {
                window.opener.postMessage({ action: 'toggleSpeechButton' }, '*');
            }

            // 버튼 텍스트 변경
            updateSpeechButtonText();
        }

        // 음성 버튼 상태에 따라 버튼 텍스트 변경
        function updateSpeechButtonText() {
            const isHidden = localStorage.getItem('speechButtonHidden') === 'true';
            const button = document.getElementById('toggle-speech-button');
            button.textContent = isHidden ? '음성 인식 버튼 보이기' : '음성 인식 버튼 숨기기';
        }

        // 메인 페이지에서 메시지를 수신하여 즉각적으로 반응하도록 설정
        window.addEventListener('message', (event) => {
            if (event.data.action === 'show') {
                document.getElementById('toggle-speech-button').textContent = '음성 인식 버튼 보이기';
            } else if (event.data.action === 'hide') {
                document.getElementById('toggle-speech-button').textContent = '음성 인식 버튼 숨기기';
            }
        });

        // 회원 탈퇴 확인 창
        function confirmDelete() {
            return confirm('정말 회원 탈퇴 하시겠습니까?');
        }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $("input[type='checkbox']").on('click', function () {
                let count = $("input:checked[type='checkbox']").length;
                if (count > 3) {
                    $(this).prop("checked", false);
                    alert("3개까지만 선택할 수 있습니다.");
                }
            });

            // 성별 선택 폼 AJAX 처리
            $("form.gender-form").on('submit', function (event) {
                event.preventDefault(); // 기본 폼 제출 막기
                const data = $(this).serialize(); // 폼 데이터 직렬화

                $.ajax({
                    type: "POST",
                    url: $(this).attr('action'),
                    data: data,
                    success: function (response) {
                        alert("성별이 성공적으로 수정되었습니다.");
                    },
                    error: function () {
                        alert("수정 중 오류가 발생했습니다.");
                    }
                });
            });

            // 연령대 선택 폼 AJAX 처리
            $("form.age-form").on('submit', function (event) {
                event.preventDefault(); // 기본 폼 제출 막기
                const data = $(this).serialize(); // 폼 데이터 직렬화

                $.ajax({
                    type: "POST",
                    url: $(this).attr('action'),
                    data: data,
                    success: function (response) {
                        alert("연령대가 성공적으로 수정되었습니다.");
                    },
                    error: function () {
                        alert("수정 중 오류가 발생했습니다.");
                    }
                });
            });

            // 장르 수정 폼 AJAX 처리
            $("form.genre-form").on('submit', function (event) {
                event.preventDefault(); // 기본 폼 제출 막기
                const data = $(this).serialize(); // 폼 데이터 직렬화

                $.ajax({
                    type: "POST",
                    url: $(this).attr('action'),
                    data: data,
                    success: function (response) {
                        alert("장르가 성공적으로 수정되었습니다.");
                    },
                    error: function () {
                        alert("수정 중 오류가 발생했습니다.");
                    }
                });
            });
        });
    </script>
</head>

<body>
    <div class="container">
        <!-- 회원 정보 섹션 -->
        <div class="info-group">
            <!-- 비밀번호 설정 섹션 -->
            <div class="section">
                <h2>비밀번호 변경</h2>
                <form method="POST" action="{% url 'change_password' %}">
                    {% csrf_token %}
                    <input type="password" name="password1" placeholder="새 비밀번호">
                    <input type="password" name="password2" placeholder="비밀번호 확인">
                    <button type="submit">비밀번호 변경</button>
                </form>
            </div>
            <!-- 성별 및 연령대 선택 섹션 -->
            <div class="horizontal-sections">
                <div class="section">
                    <h2>성별 수정</h2>
                    <form method="POST" action="{% url 'change_gender' %}" class="gender-form">
                        {% csrf_token %}
                        {% if gender == 'M' %}
                        <h6>성별 남성</h6>
                        {% elif gender == 'F' %}
                        <h6>성별 여성</h6>
                        {% else %}
                        <h6>성별 미선택</h6>
                        {% endif %}
                        <select class="form-control" name="gender" id="gender">
                            <option value="" {% if form.gender.value|default_if_none:'' == '' %}selected{% endif %}>선택하세요</option>
                            <option value="M" {% if form.gender.value == 'M' %}selected{% endif %}>남성</option>
                            <option value="F" {% if form.gender.value == 'F' %}selected{% endif %}>여성</option>
                        </select>
                        <button type="submit">성별 수정</button>
                    </form>
                </div>
                <div class="section">
                    <h2>연령대 변경</h2>
                    <form method="POST" action="{% url 'change_age_group' %}" class="age-form">
                        {% csrf_token %}
                        선택한 연령대
                        {% if 60 > age %}
                        {% if age > 10 %}
                        {{age}}대
                        {% else %}
                        10대
                        {% endif %}
                        {% elif age == 60 %}
                        60대 이상
                        {% else %}
                        미선택
                        {% endif %}
                        <select class="form-control" name="age_group" id="age_group">
                            <option value="" {% if form.age_group.value|default_if_none:'' == '' %}selected{% endif %}>선택하세요</option>
                            <option value="10" {% if form.age_group.value == '10' %}selected{% endif %}>10대 이하</option>
                            <option value="20" {% if form.age_group.value == '20' %}selected{% endif %}>20대</option>
                            <option value="30" {% if form.age_group.value == '30' %}selected{% endif %}>30대</option>
                            <option value="40" {% if form.age_group.value == '40' %}selected{% endif %}>40대</option>
                            <option value="50" {% if form.age_group.value == '50' %}selected{% endif %}>50대</option>
                            <option value="60" {% if form.age_group.value == '60' %}selected{% endif %}>60대 이상</option>
                        </select>
                        <button type="submit">연령대 변경</button>
                    </form>
                </div>
            </div>
            <!-- 회원 탈퇴 섹션 -->
            <div class="section member-delete">
                <h2>회원 탈퇴</h2>
                <form method="POST" action="{% url 'delete_account' %}" onsubmit="return confirmDelete()">
                    {% csrf_token %}
                    <button type="submit" class="delete-button">회원 탈퇴</button>
                </form>
            </div>
        </div>

        <!-- 설정 섹션 -->
        <div class="settings-group">
            <!-- 장르 수정 섹션 -->
            <div class="section">
                <h2>장르 변경</h2>
                <h6>선택한 장르 {{genre}}</h6>
                <form method="POST" action="{% url 'change_genre' %}" class="genre-form">
                    {% csrf_token %}
                    <div class="genre-list">
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_action' value="액션" {% if '액션' in form.genre.value %}checked{% endif %}>
                            <label for="genre_action">액션</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_western' value="서부극(웨스턴)" {% if '서부극(웨스턴)' in form.genre.value %}checked{% endif %}>
                            <label for="genre_western">서부극(웨스턴)</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_animation' value="애니메이션" {% if '애니메이션' in form.genre.value %}checked{% endif %}>
                            <label for="genre_animation">애니메이션</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_martial' value="무협" {% if '무협' in form.genre.value %}checked{% endif %}>
                            <label for="genre_martial">무협</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_fantasy' value="판타지" {% if '판타지' in form.genre.value %}checked{% endif %}>
                            <label for="genre_fantasy">판타지</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_adventure' value="어드벤처" {% if '어드벤처' in form.genre.value %}checked{% endif %}>
                            <label for="genre_adventure">어드벤처</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_crime' value="범죄" {% if '범죄' in form.genre.value %}checked{% endif %}>
                            <label for="genre_crime">범죄</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_thriller' value="스릴러" {% if '스릴러' in form.genre.value %}checked{% endif %}>
                            <label for="genre_thriller">스릴러</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_melodrama' value="멜로/로맨스" {% if '멜로/로맨스' in form.genre.value %}checked{% endif %}>
                            <label for="genre_melodrama">멜로/로맨스</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_mystery' value="추리" {% if '추리' in form.genre.value %}checked{% endif %}>
                            <label for="genre_mystery">추리</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_comedy' value="코미디" {% if '코미디' in form.genre.value %}checked{% endif %}>
                            <label for="genre_comedy">코미디</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_mystery2' value="미스터리" {% if '미스터리' in form.genre.value %}checked{% endif %}>
                            <label for="genre_mystery2">미스터리</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_historical' value="사극" {% if '사극' in form.genre.value %}checked{% endif %}>
                            <label for="genre_historical">사극</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_period' value="시대극" {% if '시대극' in form.genre.value %}checked{% endif %}>
                            <label for="genre_period">시대극</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_horror' value="공포(호러)" {% if '공포(호러)' in form.genre.value %}checked{% endif %}>
                            <label for="genre_horror">공포(호러)</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_investigation' value="수사" {% if '수사' in form.genre.value %}checked{% endif %}>
                            <label for="genre_investigation">수사</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_drama' value="드라마" {% if '드라마' in form.genre.value %}checked{% endif %}>
                            <label for="genre_drama">드라마</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_documentary' value="다큐멘터리" {% if '다큐멘터리' in form.genre.value %}checked{% endif %}>
                            <label for="genre_documentary">다큐멘터리</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_sf' value="SF" {% if 'SF' in form.genre.value %}checked{% endif %}>
                            <label for="genre_sf">SF</label>
                        </div>
                        <div class="genre-item">
                            <input type="checkbox" name='genre' id='genre_etc' value="기타" {% if '기타' in form.genre.value %}checked{% endif %}>
                            <label for="genre_etc">기타</label>
                        </div>
                    </div>
                    <button type="submit">장르 변경</button>
                </form>
            </div>
            <!-- 화면 색상 반전 및 음성 인식 버튼 섹션 -->
            <div class="horizontal-sections">
                <div class="section">
                    <h2>화면 색상 반전</h2>
                    <div style="text-align: center;">
                        <button onclick="toggleDarkMode()">색상 반전</button>
                    </div>
                </div>
                <div class="section">
                    <h2>음성 버튼 숨기기/보이기</h2>
                    <button id="toggle-speech-button" onclick="toggleSpeechButton()">음성 인식 버튼 숨기기</button>
                </div>
            </div>
            <!-- 대화 기록 추출 및 홈 버튼 섹션 -->
            <div class="horizontal-sections chat-extraction">
                <div class="section">
                    <h2>대화 기록 추출</h2>
                    <form method="POST" action="{% url 'chat_export' %}">
                        {% csrf_token %}
                        <button type="submit">대화 기록 추출</button>
                    </form>
                </div>
                <div class="section">
                    <h2>메인 페이지로 이동</h2>
                    <button onclick="window.location.href='/'">Home</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
{% endblock %}
