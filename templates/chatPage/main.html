{% extends 'base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Movie</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="anonymous">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        /* 전체적인 레이아웃 및 스타일 설정 */
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* 컨테이너 스타일 */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            margin: 0; /* 기본 마진 제거 */
        }

        /* 사이드바 스타일 */
        .sidebar {
            width: 300px;
            background-color: #202020;
            padding: 20px 0 20px 20px; /* 왼쪽 여백 제거 */
            overflow-y: auto;
            transition: width 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #2a2a2a #1a1a1a; /* Firefox */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 추가: 컨텐츠를 상하로 정렬 */
        }

        /* 사이드바 스크롤바 스타일 */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: #2a2a2a; 
            border-radius: 10px;
            border: 2px solid #1a1a1a;
        }

        /* 축소된 사이드바 스타일 */
        .sidebar.collapsed {
            width: 100px; /* 축소 시 너비를 넓혀 툴팁이 완전히 보이도록 설정 */
        }

        /* 사이드바 제목 스타일 */
        .sidebar h2 {
            margin: 0 0 20px 0; /* 왼쪽 여백 제거 */
            font-size: 24px;
            font-weight: 500;
            color: #f4a261;
            transition: font-size 0.3s ease, margin 0.3s ease, opacity 0.3s ease;
        }

        /* 축소된 사이드바 제목 스타일 */
        .sidebar.collapsed h2 {
            font-size: 18px;
            margin: 0;
            opacity: 0;
        }

        /* 사이드바 토글 버튼 스타일 */
        .toggle-button {
            background-color: #d3d3d3; /* 밝은 회색 */
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
            position: relative;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none; /* 파란색 윤곽선 제거 */
        }

        .toggle-button:focus {
            outline: none; /* 포커스 시 파란색 윤곽선 제거 */
        }

        .toggle-button:hover {
            background-color: #c0c0c0;
        }

        .toggle-button::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .toggle-button.left::before {
            border-width: 10px 15px 10px 0;
            border-color: transparent #202020 transparent transparent;
            left: 15px;
            top: 10px;
        }

        .toggle-button.right::before {
            border-width: 10px 0 10px 15px;
            border-color: transparent transparent transparent #202020;
            left: 10px;
            top: 10px;
        }

        .toggle-button::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #202020;
            color: white;
            padding: 5px;
            border-radius: 5px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }

        .toggle-button:hover::after {
            opacity: 1;
        }

        /* 추천 영화 로그 스타일 */
        .recommendation-log {
            margin: 0 0 10px 0; /* 왼쪽 여백 제거 */
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            cursor: pointer;
            font-size: 18px;
            color: #d3d3d3;
            transition: font-size 0.3s ease, opacity 0.3s ease;
            text-align: left; /* 텍스트를 왼쪽 정렬 */
        }

        .sidebar.collapsed .recommendation-log {
            font-size: 14px;
            opacity: 0;
        }

        /* 메인 콘텐츠 스타일 */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            padding: 20px;
        }

        /* 채팅 컨테이너 스타일 */
        .chat-container {
            width: 80%;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* 채팅 박스 스타일 */
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #2a2a2a #1a1a1a; /* Firefox */
        }

        /* 채팅 박스 스크롤바 스타일 */
        .chat-box::-webkit-scrollbar {
            width: 8px;
        }

        .chat-box::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }

        .chat-box::-webkit-scrollbar-thumb {
            background-color: #2a2a2a; 
            border-radius: 10px;
            border: 2px solid #1a1a1a;
        }

        /* 메시지 스타일 */
        .message {
            display: flex;
            margin-bottom: 10px;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .message.user .text {
            background-color: #f8c582; /* 연한 주황색 */
            margin-left: auto;
            color: #1a1a1a;
        }

        .message.bot .text {
            background-color: #444;
            margin-right: auto;
            color: #f0f0f0;
        }

        .text {
            padding: 10px 20px;
            border-radius: 20px;
            max-width: 60%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* 입력 영역 스타일 */
        .input-area {
            display: flex;
            align-items: flex-end; /* 항목을 아래쪽에 정렬 */
            padding: 10px;
            border-top: 1px solid #444;
            background-color: #202020;
            width: 100%;
            box-sizing: border-box;
            border-radius: 0 0 10px 10px;
            margin-top: 10px;
        }

        .input-area textarea {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #444;
            background-color: #444;
            color: white;
            margin-right: 10px;
            resize: none; /* 텍스트 영역 크기 조정 방지 */
            height: 50px; /* 고정 높이 설정 */
            font-size: 16px; /* 글꼴 크기 조정 */
            line-height: 1.5; /* 줄 높이 조정 */
            box-sizing: border-box;
            outline: none; /* 파란색 윤곽선 제거 */
            overflow: hidden; /* 오버플로 콘텐츠 숨기기 */
        }

        .input-area button {
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: #f4a261;
            color: #202020;
            cursor: pointer;
            width: 80px;
            flex-shrink: 0;
            height: 50px; /* 전송 버튼의 높이 고정 */
            transition: background-color 0.3s ease, transform 0.3s ease;
            align-self: flex-end; /* 버튼을 아래쪽에 정렬 */
        }

        .input-area button:hover {
            background-color: #e6954e;
            transform: scale(1.05);
        }

        /* 미디어 쿼리: 작은 화면용 스타일 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 60px;
                display: flex;
                align-items: center;
            }

            .sidebar.collapsed {
                width: 100%;
                height: 60px;
            }

            .sidebar h2 {
                font-size: 18px;
                margin: 0;
                opacity: 1;
            }

            .sidebar.collapsed h2 {
                font-size: 18px;
                margin: 0;
                opacity: 1;
            }

            .recommendation-log {
                display: none;
            }
        }

        .mypage-button {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%; /* 버튼의 너비를 100%로 설정 */
        }

        .mypage-button:hover {
            background-color: #e67e22;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 사이드바 -->
        <div id="sidebar" class="sidebar">
            <div>
                <button class="toggle-button left" onclick="toggleSidebar()" data-tooltip="사이드바 닫기"></button>
                <h2>추천한 영화 목록</h2>
                <div id="recommendation-log"></div>
            </div>
            {% if user.is_authenticated %}
            <button class="mypage-button" data-href="{% url 'mypage' %}" onclick="window.location.href=this.getAttribute('data-href')">My Page</button>
            {% endif %}
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="main">
            <div class="chat-container">
                <div id="chat-box" class="chat-box">
                    {% for i in context %}
                        <div class="message user">
                            <div class="text">{{ i.content }}</div>
                        </div>
                    {% endfor %}
                </div>
                <form class="search-form" id="userchat" method="POST" action="{% url 'userchat' %}">
                    {% csrf_token %}
                    <div class="input-area">
                        <textarea id="user-input" name="content" placeholder="메시지 입력..." onkeypress="handleKeyPress(event)"></textarea>
                        <input type="hidden" name="author" value="{{ user.id }}">
                        <button style="width: 50px; background-color: white; margin-right: 10px;" onclick="inputMike(event)">
                            <img src="https://gongu.copyright.or.kr/gongu/wrt/cmmn/wrtFileImageView.do?wrtSn=13073475&filePath=L2Rpc2sxL25ld2RhdGEvMjAxOC85OC9DTFMyLzEzMDczNDc1X0NOVFJfV1JUMjAxODA0MjZfMzAy&thumbAt=Y&thumbSe=b_tbumb&wrtTy=10004" alt="음성입력" width="30px" height="30px">
                        </button>
                        <button type="submit" onclick="sendMessage(event)">전송</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="news">
            {% for n in news %}
                <p><a href="{{n.0}}">{{n.1}}</a></p>
            {% endfor %}
        </div>
    </div>
    <script>
        const recommendations = {}; // 추천 영화 목록을 저장할 객체

        document.addEventListener('DOMContentLoaded', () => {
            const chatBox = document.getElementById('chat-box');
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'message bot';
            const botMessageTextDiv = document.createElement('div');
            botMessageTextDiv.className = 'text';
            botMessageDiv.appendChild(botMessageTextDiv);
            chatBox.appendChild(botMessageDiv);

            // 초기 환영 메시지
            const welcomeMessage = '안녕하세요! 무엇을 도와드릴까요?';
            let i = 0;
            const interval = setInterval(() => {
                if (i < welcomeMessage.length) {
                    botMessageTextDiv.textContent += welcomeMessage.charAt(i);
                    i++;
                } else {
                    clearInterval(interval);
                }
            }, 50);
        });

        async function sendMessage(event) {
            event.preventDefault(); // 폼의 기본 제출 동작 방지
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const recommendationLog = document.getElementById('recommendation-log');
            const userMessage = input.value.trim();

            if (userMessage !== '') {
                // 사용자 메시지 표시
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'message user';
                userMessageDiv.innerHTML = `<div class="text">${userMessage}</div>`;
                chatBox.appendChild(userMessageDiv);

                // 봇 응답
                const recommendedMovie = recommendMovie();
                const botResponse = `오늘 추천드리는 영화는 "${recommendedMovie}"입니다.`;
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot';
                const botMessageTextDiv = document.createElement('div');
                botMessageTextDiv.className = 'text';
                botMessageDiv.appendChild(botMessageTextDiv);
                chatBox.appendChild(botMessageDiv);

                let i = 0;
                const interval = setInterval(() => {
                    if (i < botResponse.length) {
                        botMessageTextDiv.textContent += botResponse.charAt(i);
                        i++;
                    } else {
                        clearInterval(interval);
                    }
                }, 50);

                // 서버에 메시지 전송 (AJAX)
                const response = await fetch("{% url 'userchat' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        content: userMessage,
                        author: '{{ user.id }}'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(result.message);
                } else {
                    console.error('Error:', response.statusText);
                }

                // 추천 영화 목록에 추가
                if (!recommendations[recommendedMovie]) {
                    recommendations[recommendedMovie] = [
                        {sender: 'bot', text: '안녕하세요! 무엇을 도와드릴까요?'},
                        {sender: 'user', text: userMessage},
                        {sender: 'bot', text: botResponse}
                    ];

                    const recommendationLogDiv = document.createElement('div');
                    recommendationLogDiv.className = 'recommendation-log';
                    recommendationLogDiv.innerText = recommendedMovie;
                    recommendationLogDiv.onclick = () => loadRecommendation(recommendedMovie);
                    recommendationLog.appendChild(recommendationLogDiv);
                }

                // 채팅 박스 스크롤 조정
                chatBox.scrollTop = chatBox.scrollHeight;
                input.value = '';
                input.style.height = '50px'; // 텍스트 영역 높이 초기화
            }
        }

        function adjustTextareaHeight() {
            const input = document.getElementById('user-input');
            input.style.height = '50px'; // 기본 높이로 초기화
            input.style.height = input.scrollHeight + 'px'; // 내용에 따라 높이 조정
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        function recommendMovie() {
            const movies = ["인셉션", "인터스텔라", "다크 나이트", "기생충", "타이타닉"];
            return movies[Math.floor(Math.random() * movies.length)];
        }

        function loadRecommendation(key) {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            const recommendation = recommendations[key];
            recommendation.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}`;
                messageDiv.innerHTML = `<div class="text">${message.text}</div>`;
                chatBox.appendChild(messageDiv);
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.querySelector('.toggle-button');
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                toggleButton.classList.replace('left', 'right'); // 오른쪽 삼각형 아이콘으로 변경
                toggleButton.setAttribute('data-tooltip', '사이드바 열기');
            } else {
                toggleButton.classList.replace('right', 'left'); // 왼쪽 삼각형 아이콘으로 변경
                toggleButton.setAttribute('data-tooltip', '사이드바 닫기');
            }
        }

        function inputMike(event) {
            event.preventDefault(); // 폼의 기본 제출 동작 방지
            if (!('webkitSpeechRecognition' in window)) { // 음성 지원되는지 확인
                alert('음성 인식을 지원하지 않는 브라우저입니다.');
                return;
            }

            const messageArea = document.getElementById("user-input");
            messageArea.innerText = "말하세요...";

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.start();
            
            recognition.onresult = function(event) {
                const speechResult = event.results[0][0].transcript;

                // 서버에 음성 데이터를 텍스트로 변환 요청
                fetch("{% url 'mike' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({ speech: speechResult })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("user-input").value = data.transcribed_text;
                    messageArea.innerText = "";
                })
                .catch(error => {
                    console.error("Error:", error);
                    messageArea.innerText = "(오류가 발생했습니다)";
                });
            };

            recognition.onerror = function(event) {
                console.error("Speech recognition error:", event.error);
                messageArea.innerText = "(음성 인식 오류가 발생했습니다)";
            };
        }
    </script>
</body>
</html>
{% endblock %}
